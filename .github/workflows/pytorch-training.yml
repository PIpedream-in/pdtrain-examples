name: PyTorch Training Example

on:
  workflow_dispatch:
  push:
    branches: [main]
    paths:
      - 'pytorch-script-minimal/**'

jobs:
  train:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v5

      - name: Upload dataset
        id: dataset
        uses: PIpedream-in/upload-dataset-action@v1
        with:
          api-key: ${{ secrets.PDTRAIN_API_KEY }}
          api-url: https://6c68b9fad00b.ngrok-free.app
          path: ./pytorch-script-minimal/data
          name: pytorch-minimal-data-${{ github.run_number }}
          description: PyTorch minimal training dataset

      - name: Train PyTorch Model
        id: train
        uses: PIpedream-in/train-ml-action@v1
        with:
          api-key: ${{ secrets.PDTRAIN_API_KEY }}
          api-url: https://6c68b9fad00b.ngrok-free.app
          code-path: ./pytorch-script-minimal
          entry-point: train.py
          dataset: ${{ steps.dataset.outputs.dataset-id }}
          framework: pytorch
          download-artifacts: false
          exclude-patterns: data/
          framework-version: 2.2.0
          python-version: py310
          hyperparameters: |
            epochs: 2
            batch_size: 16
            learning_rate: 0.001

      - name: Show results
        run: |
          echo "## PyTorch Training Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Run ID:** \`${{ steps.train.outputs.run-id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- **Status:** ${{ steps.train.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Cost:** \$${{ steps.train.outputs.cost }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Runtime:** ${{ steps.train.outputs.runtime-seconds }}s" >> $GITHUB_STEP_SUMMARY

